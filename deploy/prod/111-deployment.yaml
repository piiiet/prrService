apiVersion: extensions/v1beta1
kind: Deployment
metadata:
 name: document
 namespace: green-prod
 labels:
  name: document
spec:
  replicas: 1
  template:
    metadata:
      name: document
      namespace: green-prod
      labels:
        tier: backend
        lang: nodejs
        name: documentservice
    spec:
      containers:
        - name: document
          image: nexussrv.office.traffics-switch.de:9843/traffics/documentservice
          imagePullPolicy: Always
          resources:
            requests:
              cpu: 250m
          env:
            - name: NODE_ENV
              value: production
            - name: LOG_LEVEL
              value: info
            - name: DOCKER_HOST_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          livenessProbe:
            httpGet:
              path: /alive
              port: web
            initialDelaySeconds: 3
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /alive
              port: web
            initialDelaySeconds: 3
            periodSeconds: 15
          volumeMounts:
            - name: trafficsinternalrootcacrt
              mountPath: "/etc/traffics/ssl/"
              readOnly: true
            - name: authserviceconfig
              mountPath: "/etc/authservice/config/"
              readOnly: true
          ports:
          - name: web
            containerPort: 3010
      volumes:
        - name: trafficsinternalrootcacrt
          secret:
            secretName: traffics-internal-root-ca-crt
        - name: authserviceconfig
          secret:
            secretName: auth-service-config
      imagePullSecrets:
        - name: nexusregisterykey
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: document
  namespace: green-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1beta1
    kind: Deployment
    name: document
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 50
